{"componentChunkName":"component---src-templates-blog-post-js","path":"/speculative-execution/","result":{"data":{"site":{"siteMetadata":{"title":"Out of Order Core"}},"markdownRemark":{"id":"e0584073-82f0-5f3b-b564-1ff6da6664d7","excerpt":"Most of the recent CPU vulnerability discovered depend on the property of modern processors known as Speculative Execution. In this post, we’ll take a deeper…","html":"<p>Most of the recent CPU vulnerability discovered depend on the property of modern processors known as Speculative Execution. In this post, we’ll take a deeper look at where and why modern processors speculate.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.87341772151899%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAACBElEQVQozzWS70tTURzG7x/R2wr6H3pVvamgeiPhLAexiihShOhFxSBJCNGMIBDJIhEaxF6oQ8vQEsW6uOkUl229mXvR3PS6u3vP/TW3pO4+ca75wIdzOHAevs95jlKtViluFdnZ3sZybZ6kX/BwtZdoup/oSh+PVp/Rqz5FWwiz8yVEabaV0ucQxnwLlXQPXq3B3t4ejUYdy7JQDMMgn89TLpVxPJdb6gPakh20p7oIp7oIpe/RuXCTv7Mn8CaOob0/SiV+HP/DERpqmD8+NJs+UrVaDUVums1mcOD7Pp+yc0xsTDOe+chYZorxjWkS61PMrSVY+J5g8UcCNZdgcSPOcnaGql5F13VkUoniOA6bm5tsFYvUf9cJfb3LefUal9QbXPgW4aJ6nbMzYc7NRzgz1c7pyaucGr/CyclWOpd74GC4QK7rHhjK2EII6o06sZ9jvM7FGM7GeJV9x3AuxuDqCC/X3jC4PhIwlBllMPOWeC6BYztID2kmPZT9/f1gZNMwsF2b/rUhulee050a4HFygGiqj4HkEHq5gr5VoVrWETsmYttAaGZgdmhomiaKzF0oFCj+KqLpGpHkfS4v3QmKaVvqoGXpNh1qNPgB2q7Grr6LVpFoCFsE734oz/NQZCGH+E0f27MxbfEfE+EITEsEE8gW5SW5SgzTxBQWlmUHuF6Nf3IMGbhQPpSOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A illustration that shows speculative execution and how the results are committed or discarded based on result of speculation - whether it was correct or not respectively.\"\n        title=\"A illustration that shows speculative execution and how the results are committed or discarded based on result of speculation - whether it was correct or not respectively.\"\n        src=\"/static/6fc9c9792dc4fc914dff57f770eaf4fe/f058b/banner.png\"\n        srcset=\"/static/6fc9c9792dc4fc914dff57f770eaf4fe/c26ae/banner.png 158w,\n/static/6fc9c9792dc4fc914dff57f770eaf4fe/6bdcf/banner.png 315w,\n/static/6fc9c9792dc4fc914dff57f770eaf4fe/f058b/banner.png 630w,\n/static/6fc9c9792dc4fc914dff57f770eaf4fe/a0209/banner.png 725w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<center>\nAlt: A illustration that shows speculative execution and how the results are committed or discarded based on result of speculation - whether it was correct or not respectively.\n<br/>\nMade with <a href=\"https://excalidraw.com/\" target=\"_blank\">https://excalidraw.com/</a> (link opens a new tab)\n</center>\n<h2>Pipelined Execution</h2>\n<p>Most modern processors are pipelined and are often superscalar in nature running instructions out of order, with multiple stages of execution of instruction running concurrently.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.22784810126582%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACO0lEQVQoz22T3WoTQRiG50I89k68AaFVROip9u/ICt6ACIKnhXpsUCrpQe2JSEUw1qYppGlMutnEzWZ/ku2m2c1/zWbzyExsQ2oHZl5mYF6e7535hG3X6Ha7mKZJEARUq1Xq9TqaViSf09k7XufVxzsc6K+RI44jpZPJRM2bQ9RqBsPhEF3XCcNQqeM45E6zHP3M8y51j+Utwef8039X4luNrg3DsEWn84dKxaDdDjEMA9d1KVdKnBVMPqTus7ol2Dtew/e6XLT8OcKbpEIuQTBB10263TaWZeF5HvW6Q90OSHxbZHlTkEytkD/RMaq/ry/fWvJ4PKLXA9tu0OsNsG1nathwcWoXbB8ssvpWsHu0QvGXgWWbKqJ+v/9fllJFFEXEsTwcK1LH8fD9c5rNc1yrxc7xAs/fC3bSSxz+yFHSzygWi+RyuTnKKxXTzRS30wHLquN5Dfymh202SWYW2EgIkodLHHzPopWKaJpGPp9XJuPxmDiOZ4Qz5AlRJOeIy8sYx72g5ff5dPpQEe5rq+hnNq5rk81mFaX8DVJHo9F16eK2gKMIjKqP32izm3vAs4Q0XEMr1LAsk1QqxcnJifoRmUwGGdvcK8/nIMuAIOwyGkIy85gX24KvpXVqhq+ikFTSrFQqKVrf91VjDAaDGeGMVK3AWO0TqUdsbAv29SeYlXPa7YByuaz+qnyYdDqtzKTKxhDzZlNCKVct9uX0JZv7dzmqvsGpNQnClmpPaSgJ5ePILAuFAp1Oh7+/6mcBE0lnqwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Pipeline of a superscalar processor with 2 instruction fetch every clock cycle and a 5 stage pipeline.\"\n        title=\"Pipeline of a superscalar processor with 2 instruction fetch every clock cycle and a 5 stage pipeline.\"\n        src=\"/static/0a80897d7a4b2db5ed70abb7e91489d5/f058b/1024px-Superscalarpipeline.png\"\n        srcset=\"/static/0a80897d7a4b2db5ed70abb7e91489d5/c26ae/1024px-Superscalarpipeline.png 158w,\n/static/0a80897d7a4b2db5ed70abb7e91489d5/6bdcf/1024px-Superscalarpipeline.png 315w,\n/static/0a80897d7a4b2db5ed70abb7e91489d5/f058b/1024px-Superscalarpipeline.png 630w,\n/static/0a80897d7a4b2db5ed70abb7e91489d5/40601/1024px-Superscalarpipeline.png 945w,\n/static/0a80897d7a4b2db5ed70abb7e91489d5/2bef9/1024px-Superscalarpipeline.png 1024w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<center>\nAlt: Pipeline of a superscalar processor with 2 instruction fetch every clock cycle and a 5 stage pipeline.\n<br/>\nSource (link opens a new tab): <a href=\"https://en.wikipedia.org/wiki/Superscalar_processor\" target=\"_blank\">https://en.wikipedia.org/wiki/Superscalar_processor</a>\n</center>\n<br />\n<p>In case of a long latency cache miss, permission check for an access or conditional branches, the processor generally has to stall waiting for these outstanding data and results to be fetched to continue execution. Generally a nop - signifying no operation, is sent through the pipeline and the process is known as stalling the pipeline.</p>\n<p>Stalling pipeline is easy and safe but the processor could have been doing useful work in that time instead of sitting idle waiting for data or results. This expensive idling is what fueled the era or speculative execution</p>\n<h2>Speculating Conditional Branches</h2>\n<p>Consider the following snippet of C code:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>ptr<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>ptr<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n        <span class=\"token function\">do_something</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Consider the data pointed to by the address in pointer ptr is not cached, It’ll take several hundreds of clock cycles to fetch the data from the main memory. Idling for hundreds of clock cycle especially in a superscalar processor massively degrades the performance.</p>\n<p>In this case, processor goes into a state of speculation and starts executing instruction based on prediction of whether the branch will be taken or not. This process is known as branch prediction - we won’t go into details of branch prediction in this post but if you want to learn more about branch prediction you can read the Wikipedia article titled <a href=\"https://en.wikipedia.org/wiki/Branch_predictor\" target=\"_blank\">Branch Prediction</a> (link opens a new tab) which talks briefly about the branch prediction algorithms but if you want to understand how modern processor implement branch prediction in hardware, you can read this blog by Cloudflare titled <a href=\"https://blog.cloudflare.com/branch-predictor/\" target=\"_blank\">Branch predictor: How many “if”s are too many? Including x86 and M1 benchmarks!</a> (link opens a new tab) where Marek Majkowski takes a look at how Branch Target Buffers work.</p>\n<p>Coming back to the example snippet, the processor may speculate that the value at address pointed by ptr is indeed non zero and start executing the <strong>do_something()</strong> routine speculatively. It is only later, when the data arrives, will the processor come out of speculative execution state. In case of a mis-speculation, the pipeline is flushed, the processor state is reset to the point of speculation and the execution continues in the correct direction. On a high level, speculation is completely safe as the user cannot read the results computed during speculation and only after a speculation is deemed correct or incorrect, the user can see the changes reflect in the registers. </p>\n<h2>Speculating Permission Check</h2>\n<p>As it turns out, checking whether a program can access data at particular address takes quite some time. In this case too the processor speculates if the access if valid or not and continues with execution or program or stall respectively. Consider the same above example - if data at the address pointed by ptr is cached, the processor may speculate that this data indeed accessible to the userspace program and speculatively execute the following statement based on value at address pointed by ptr. It is only later, when the permission check is complete will the processor come out of speculative execution state. Same as before, in case of a mis-speculation, the pipeline is flushed, the processor state is reset to the point of speculation and the execution continues in the correct direction.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 505px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.53164556962025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB3ElEQVQoz4WSyW4TQRCG5+YgJF4ALHLME+TZQNyQkFDIhRviAJK5sEiAQoK4cgBCvETBS8Y4sYU1g3d73LN6tg91GxtjC9FSqWuqar6u+rs1gDRNWV3yOwgCptMpjuMof71mUbce1xYBuU8mE3q93nLvdrs0m00Mw1Dw8XiM7/vEcUySJBtgaUughPT7fQWSP1uWpfx2u81wOGQ0Gqm8hMqYrus0Gg3q9bqySqXCYDD4A5SFYRguT5SdSOhi7CiKVE4IoeparRbValWBpMkpZOd/AT3PgzQhTWOJJU3kaL/9NFE513XUAbVabQmUcNml1FpLkzlQWAIS/rvG1hwoG5ETlEolJcdCVy1lDqyblxT1TwjzFMvMY3dOsIxjhPkFYR5jGV9xOnnKJ++VDAtppBSrN63V9HO84ZRXrY/cyu3C4U16r7e5fJbFfJHlIncD43kW53Cb4Og6nYNdojBYXO/GTWuFYoH2+QVPah+4nduBtxlGL6+iP8rw4+kW3x9vYeSuEB5cI32Xof9mh9ks2HguS6DruRAlFH/qHH1+iH26x/hsH1HeZ/rtAXb5PuLsHpPSXSaFO3TzeyRx/E+NtfWALE1WLF4zPwJhO3iej+v5OK6H7bgI22UWhvwC5hUwXceURmAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A block diagram that shows speculative execution in case that check for data access takes longer than fetching data. The processor comes out of the speculative state once the check has resolved.\"\n        title=\"A block diagram that shows speculative execution in case that check for data access takes longer than fetching data. The processor comes out of the speculative state once the check has resolved.\"\n        src=\"/static/72dff352104c079dbedb6fd405b92708/c0cb9/mem_access.png\"\n        srcset=\"/static/72dff352104c079dbedb6fd405b92708/c26ae/mem_access.png 158w,\n/static/72dff352104c079dbedb6fd405b92708/6bdcf/mem_access.png 315w,\n/static/72dff352104c079dbedb6fd405b92708/c0cb9/mem_access.png 505w\"\n        sizes=\"(max-width: 505px) 100vw, 505px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<center>\nAlt: A block diagram that shows speculative execution in case that check for data access takes longer than fetching data. The processor comes out of the speculative state once the check has resolved.\n<br/>\nMade with <a href=\"https://excalidraw.com/\" target=\"_blank\">https://excalidraw.com/</a> (link opens a new tab)\n</center>\n<h2>Pitfalls</h2>\n<p>The main pitfall of speculation is the fact that during a miss prediction, most processor reset their state but the traces of the speculation is left in caches and as seen in previous post of Timing Analysis, we can read the data from the cache using a device and timing analysis.</p>\n<h2>Coming up next</h2>\n<p>In the next post we’ll look at Meltdown, a CPU vulnerability that used speculative execution and timing analysis to read kernel memory.</p>\n<p>Thank you for reading till the end. I’m an undergraduate student keenly interested in Computer Architecture and I look at micro-architectural based attacks to understand more about the working of our hardware. If you find any inaccuracies in the above post, please leave a comment and I’ll address it in the next edit. Have a nice day!</p>","frontmatter":{"title":"Speculative Execution","date":"June 27, 2021","description":"Some of the most serious microarchitectural vulnerabilities discovered in recent times such as Spectre and Meltdown exploit the feature in modern processors called Speculative Execution. In this post we'll take a brief look at Speculative Execution and reason why modern processors speculate in certain scenarios, and why it has become a security concern."}},"previous":{"fields":{"slug":"/prime-and-probe/"},"frontmatter":{"title":"Prime and Probe"}},"next":{"fields":{"slug":"/meltdown/"},"frontmatter":{"title":"Meltdown: Reading Kernel Memory from User Space"}}},"pageContext":{"id":"e0584073-82f0-5f3b-b564-1ff6da6664d7","previousPostId":"59fe6934-0bda-555c-a295-8524d103c437","nextPostId":"ac45fb3d-a084-52b9-a78d-57e8214c4aad"}},"staticQueryHashes":["2841359383","3257411868"]}